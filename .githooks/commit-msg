#!/usr/bin/env bash
# commit-msg hook: Conventional Commit 포맷 검증 + 이슈 번호 권장
# 설치: git config core.hooksPath .githooks (npm prepare 자동 실행)

set -euo pipefail

MSG_FILE="$1"
MSG=$(head -1 "$MSG_FILE")

# --- Conventional Commit 포맷 검증 (차단) ---
# type(scope): subject  또는  type: subject
PATTERN='^(feat|fix|refactor|test|docs|chore|style|perf|ci|build|revert)(\([a-zA-Z0-9_-]+\))?: .+'

if ! echo "$MSG" | grep -qE "$PATTERN"; then
  echo ""
  echo "❌ 커밋 메시지가 Conventional Commit 포맷이 아닙니다."
  echo ""
  echo "  올바른 형식: <type>(<scope>): <subject>"
  echo "  예시: feat(hooks): add commit-msg validation"
  echo ""
  echo "  허용 type: feat|fix|refactor|test|docs|chore|style|perf|ci|build|revert"
  echo ""
  exit 1
fi

# --- 이슈 번호 참조 권장 (경고만) ---
if ! echo "$MSG" | grep -qE '(#[0-9]+|[A-Z]+-[0-9]+)'; then
  echo ""
  echo "⚠️  커밋 메시지에 이슈 번호가 없습니다."
  echo "  권장: feat(hooks): add validation (#13)"
  echo "  또는 본문에: Closes #13"
  echo ""
fi

# --- main 브랜치 직접 커밋 경고 ---
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")

if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo ""
  echo "⚠️  '$BRANCH' 브랜치에 직접 커밋 중입니다."
  echo "  권장: feature 브랜치에서 작업 후 PR을 생성하세요."
  echo "  예시: git checkout -b feat/13-add-hooks"
  echo ""
fi

exit 0
