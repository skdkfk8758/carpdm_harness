# Plan Gate (Interview + SPARC Process)

사용자 요청을 분석하고, **인터뷰를 통해 요구사항을 명확히 한 후** SPARC(Spec→Pseudocode→Architecture→Refinement→Completion) 프로세스로 계획을 수립한다. 코드 작성 전에 반드시 계획을 수립하고 승인을 받는다.

## Argument: $ARGUMENTS
요청 내용을 분석하여 plan-gate를 실행한다.

## Instructions

### Pre-Check: 기존 계획 확인 (Plan Already Provided)

사용자가 이미 상세한 계획/플랜을 프롬프트에 포함한 경우:

**판단 기준**: 프롬프트에 다음 키워드가 3개 이상 포함되면 "계획 이미 제공됨"으로 간주한다:
- "Step", "변경 파일", "검증", "구현 계획", "Edge Case", "리스크"

**계획 제공 시 단축 경로**:
1. 제공된 계획의 완성도를 검증한다 (목표, 범위, 변경 파일, 검증 방법)
2. 부족한 부분이 있으면 해당 카테고리만 AskUserQuestion으로 보충 질문
3. **Phase 1(인터뷰)을 건너뛰고** Phase 2(도메인 컨텍스트)부터 진행
4. 단, **todo.md는 반드시 작성**한다 (이 단계는 스킵 불가)

> 계획이 이미 제공되었더라도 todo.md 작성과 사용자 승인은 필수이다.

### Phase 0: 작업 규모 판단

작업 시작 전, AskUserQuestion으로 규모를 확인한다:

**질문**: "이 작업의 규모는 어느 정도인가요?"
- **대규모 변경 (Safety Mode)**: 아키텍처 변경, 다수 파일 수정, 새 기능 추가 → 인터뷰 5개 + SPARC 전체
- **소규모 변경 (Speed Mode)**: 버그 수정, 단일 기능, 소수 파일 → 인터뷰 2개 + SPARC 간소화

> 사용자가 이미 Speed/Safety를 설정에서 지정한 경우 이 단계를 건너뛴다.

### Phase 1: 사용자 인터뷰 (Discovery Interview)

코드를 작성하기 전에 사용자와 대화하며 요구사항을 구체화한다.
AskUserQuestion 도구를 활용하여 한 번에 1-2개씩 순차적으로 질문한다.

#### 1-1. 목표 & 범위 (Goal & Scope)
- **핵심 질문**: "이 작업의 핵심 목표는 무엇인가요?"
- 후속 확인:
  - 해결하려는 문제가 정확히 무엇인지
  - 기대하는 최종 결과물
  - 이 작업의 성공 기준은?

#### 1-2. 사용자 시나리오 (User Scenarios)
- **핵심 질문**: "주요 사용자와 핵심 유스케이스는 무엇인가요?"
- 후속 확인:
  - 대상 사용자 (페르소나)
  - 핵심 플로우 (Happy Path)
  - 엣지 케이스 (2개 이상 식별 필수)

#### 1-3. 기술적 제약 (Technical Constraints)
- **핵심 질문**: "기술적 제약이나 호환성 요구사항이 있나요?"
- 후속 확인:
  - 기존 시스템/코드와의 호환성
  - 성능 요구사항 (응답 시간, 처리량)
  - 외부 의존성/라이브러리 제한

> 코드베이스 사실은 사용자에게 묻지 않는다 — 직접 코드를 읽고 확인한다.

#### 1-4. 우선순위 & 스코프 (Priority & Scope Boundary)
- **핵심 질문**: "Must-have와 Nice-to-have를 구분해 주세요."
- 후속 확인:
  - 이번 작업에 포함되는 것 / 포함되지 않는 것
  - 향후 확장 계획 (있다면)
  - 타임라인/데드라인

#### 1-5. 리스크 & 검증 (Risk & Verification)
- **핵심 질문**: "허용 가능한 리스크 수준과 테스트 전략은?"
- 후속 확인:
  - 기존 기능에 미치는 영향
  - 롤백 전략
  - 검증 방법 (수동 테스트, 자동 테스트, 둘 다)

#### 인터뷰 진행 규칙
- 한 번에 1-2개 카테고리만 질문 (사용자 피로도 관리)
- 사용자 답변이 충분히 명확하면 후속 질문 생략 가능
- 코드베이스 관련 사실은 질문하지 않고 직접 탐색
- 모호한 비즈니스 규칙은 반드시 질문 (No Hallucination)
- Speed Mode일 경우: 1-1, 1-4만 필수, 나머지 선택
- Safety Mode일 경우: 전체 5개 카테고리 필수

### Phase 2: 도메인 컨텍스트 로딩

인터뷰 완료 후, 해당 도메인의 관련 파일을 읽는다:

1. 사용자의 요청에서 **도메인**을 식별한다.
2. 해당 도메인의 관련 파일을 읽는다:
   - `docs/conventions.md` (전체 규약)
   - 해당 도메인의 모델/타입 파일
   - 해당 도메인의 Store/Repository 파일
   - 해당 도메인의 Route/Controller 파일
3. "로드한 문서 목록"을 명시한다.
4. 기존 패턴을 분석한다 (Pattern Copy 원칙).

#### 도메인 분석 피드백 (Safety Mode만)
Phase 2 완료 후, Safety Mode일 경우 AskUserQuestion으로 중간 확인:
- "도메인 분석 결과를 요약했습니다. [로드한 문서 + 기존 패턴 요약]. 이 방향으로 SPARC 계획을 작성해도 될까요?"
- 사용자 피드백 반영 후 Phase 3 진행
- Speed Mode에서는 이 단계를 건너뛴다.

### Phase 3: SPARC 기반 Plan 작성

`docs/templates/plan-template.md` 템플릿을 참고하여 인터뷰 결과를 반영한 `plan.md` 초안을 작성한다:

**S - Spec (명세):**
- 목표/범위/비범위 (인터뷰 1-1, 1-4 반영)
- 사용자 시나리오 (인터뷰 1-2 반영)
- Edge Case 2개 이상 (인터뷰에서 식별된 것 + 추가 분석)

**P - Pseudocode (의사코드):**
- 핵심 로직을 자연어/의사코드로 설명
- 데이터 흐름 정의

**A - Architecture (구조):**
- 변경 파일 목록(예상)
- 의존성 방향 (Domain Map 참조)
- 기술적 제약 반영 (인터뷰 1-3)

**R - Refinement (정제):**
- 리스크/검증 계획 (인터뷰 1-5 반영)
- 보안/성능 체크포인트
- **설계 이슈 분석** (발견된 각 이슈에 대해):
  1. 문제를 파일 경로 + 라인 참조와 함께 구체적으로 기술
  2. 2-3개 옵션 제시 ("변경 없음" 포함)
  3. 각 옵션별: 구현 노력(S/M/L), 리스크, 유지보수 부담 평가
  4. conventions.md 기준에 매핑한 추천 옵션 + 근거
  5. AskUserQuestion으로 사용자 선택 확인 (이슈 번호 + 옵션 문자 라벨링)

> Safety Mode: 최대 4개 이슈까지 분석 (사용자 피로도 관리)
> Speed Mode: 최대 2개 이슈까지 분석

**C - Completion (완성 계획):**
- 단계별 TODO 분해 (커밋 단위)
- 우선순위 기반 순서 (인터뷰 1-4 반영)
- 검증 명령어 (pytest, tsc 등)

### Phase 4: 승인 요청

1. `todo.md`도 함께 초안을 작성한다 (`docs/templates/todo-template.md` 기반).
2. `context.md`도 초기화한다 (`docs/templates/context-template.md` 기반).
   - 인터뷰 결과에서 도출된 주요 결정사항을 첫 번째 Decision으로 기록
   - 검토한 대안이 있으면 Trade-offs에 기록
3. 인터뷰 결과 요약을 plan.md 상단에 포함한다.
4. 마지막에 반드시: **"OK 주시면 todo 1번부터 진행합니다."**

## Rules
- 인터뷰 없이 plan을 작성하지 않는다 (인터뷰 스킵 불가)
- 이 단계에서 코드를 작성하거나 수정하지 않는다
- 기존 패턴을 반드시 확인한다 (Pattern Copy 원칙)
- Ubiquitous Language 용어를 사용한다
- 모호한 비즈니스 규칙은 질문한다 (No Hallucination)
- Edge Case를 반드시 2개 이상 식별한다
- Speed Mode: 인터뷰 간소화 + SPARC의 P/R 간소화 가능
- Safety Mode: 인터뷰 전체 + 모든 SPARC 단계 상세 작성
